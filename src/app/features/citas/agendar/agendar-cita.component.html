<div class="min-h-screen bg-slate-50 p-6">
  <!-- Header -->
  <div class="mb-8">
    <button
      (click)="goBack()"
      class="mb-4 flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Volver</span>
    </button>

    <h1 class="text-3xl font-bold text-slate-900">Agendar Cita Médica</h1>
  </div>

  <!-- Stepper Indicator -->
  <div class="mb-8 flex items-center justify-center gap-4">
    <div class="flex items-center gap-2">
      <div
        [class]="
          currentStep() >= 1
            ? 'w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold'
            : 'w-10 h-10 rounded-full bg-slate-300 text-slate-600 flex items-center justify-center'
        "
      >
        1
      </div>
      <span class="text-sm font-medium" [class.text-blue-600]="currentStep() >= 1">Médico</span>
    </div>

    <div
      class="w-12 h-1"
      [class.bg-blue-600]="currentStep() >= 2"
      [class.bg-slate-300]="currentStep() < 2"
    ></div>

    <div class="flex items-center gap-2">
      <div
        [class]="
          currentStep() >= 2
            ? 'w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold'
            : 'w-10 h-10 rounded-full bg-slate-300 text-slate-600 flex items-center justify-center'
        "
      >
        2
      </div>
      <span class="text-sm font-medium" [class.text-blue-600]="currentStep() >= 2"
        >Fecha y Hora</span
      >
    </div>

    <div
      class="w-12 h-1"
      [class.bg-blue-600]="currentStep() >= 3"
      [class.bg-slate-300]="currentStep() < 3"
    ></div>

    <div class="flex items-center gap-2">
      <div
        [class]="
          currentStep() >= 3
            ? 'w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold'
            : 'w-10 h-10 rounded-full bg-slate-300 text-slate-600 flex items-center justify-center'
        "
      >
        3
      </div>
      <span class="text-sm font-medium" [class.text-blue-600]="currentStep() >= 3">Confirmar</span>
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
      {{ error() }}
    </div>
  }

  <!-- Step 1: Select Doctor -->
  @if (currentStep() === 1) {
    <div class="max-w-2xl mx-auto">
      <h2 class="text-2xl font-semibold text-slate-900 mb-6">
        Elige el médico con el que deseas atenderte
      </h2>

      <!-- Filter by Specialty -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Filtrar por especialidad
        </label>
        <div class="flex gap-2 flex-wrap">
          <button
            (click)="clearFilter()"
            [class]="
              selectedEspecialidadId() === null
                ? 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium'
                : 'px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200'
            "
          >
            Todas
          </button>
          @for (esp of especialidades(); track esp.id) {
            <button
              (click)="filterByEspecialidad(esp.id)"
              [class]="
                selectedEspecialidadId() === esp.id
                  ? 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium'
                  : 'px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200'
              "
            >
              {{ esp.nombre }}
            </button>
          }
        </div>
      </div>

      @if (loadingMedicos()) {
        <div class="text-center py-12">
          <div
            class="inline-block w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"
          ></div>
          <p class="mt-4 text-slate-600">Cargando médicos...</p>
        </div>
      } @else {
        <div class="space-y-4">
          @for (medico of medicos(); track medico.id) {
            <button
              (click)="selectMedico(medico)"
              class="w-full flex items-center justify-between p-4 bg-white border border-slate-200 rounded-lg hover:border-blue-500 hover:shadow-md transition-all"
            >
              <div class="flex items-center gap-4">
                <!-- Doctor Avatar Placeholder -->
                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center">
                  <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>

                <div class="text-left">
                  <h3 class="font-semibold text-slate-900">
                    Dr. {{ medico.nombre }} {{ medico.apellido }}
                  </h3>
                  <p class="text-sm text-slate-600">
                    {{ medico.especialidades[0]?.nombre || 'General' }}
                  </p>
                </div>
              </div>

              <svg
                class="w-6 h-6 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          }

          @if (medicos().length === 0 && !loadingMedicos()) {
            <div class="text-center py-12 bg-white border border-slate-200 rounded-lg">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-slate-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              @if (selectedEspecialidadId()) {
                <p class="text-slate-600 mb-2">
                  No hay médicos disponibles para esta especialidad.
                </p>
                <button
                  (click)="clearFilter()"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  Ver todos los médicos
                </button>
              } @else {
                <p class="text-slate-600">No hay médicos disponibles en este momento.</p>
              }
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Step 2: Select Date & Time -->
  @if (currentStep() === 2) {
    <div class="max-w-3xl mx-auto">
      <h2 class="text-2xl font-semibold text-slate-900 mb-6">Elige la fecha y la hora</h2>

      <!-- Selected Doctor Info -->
      <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-600 font-medium">Médico seleccionado:</p>
        <p class="font-semibold text-blue-900">{{ selectedMedicoName() }}</p>
        <p class="text-sm text-blue-700">{{ selectedMedicoEspecialidad() }}</p>
      </div>

      <!-- Date Selector -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-3">Selecciona el día</h3>
        <div class="grid grid-cols-4 gap-3">
          @for (day of availableDays(); track day.date) {
            <button
              (click)="selectDate(day.date)"
              [class]="
                selectedDate() === day.date
                  ? 'p-3 rounded-lg border-2 border-blue-600 bg-blue-50 font-semibold text-blue-900'
                  : 'p-3 rounded-lg border border-slate-300 bg-white hover:border-blue-500 text-slate-700'
              "
            >
              {{ day.label }}
            </button>
          }
        </div>
      </div>

      <!-- Time Slots -->
      @if (selectedDate()) {
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-slate-900 mb-3">Selecciona la hora</h3>

          @if (loadingSlots()) {
            <div class="text-center py-8">
              <div
                class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"
              ></div>
              <p class="mt-2 text-slate-600">Cargando horarios...</p>
            </div>
          } @else {
            @if (availableSlots().length > 0) {
              <div class="grid grid-cols-4 gap-3">
                @for (slot of availableSlots(); track slot.horaInicio) {
                  <button
                    (click)="selectSlot(slot)"
                    [class]="
                      selectedSlot() === slot
                        ? 'p-3 rounded-lg border-2 border-blue-600 bg-blue-50 font-semibold text-blue-900'
                        : 'p-3 rounded-lg border border-slate-300 bg-white hover:border-blue-500 text-slate-700'
                    "
                  >
                    {{ slot.horaInicio }}
                  </button>
                }
              </div>
            } @else {
              <p class="text-center text-slate-600 py-8">
                No hay horarios disponibles para este día.
              </p>
            }
          }
        </div>
      }

      <!-- Modalidad -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-3">Modalidad</h3>
        <div class="flex gap-4">
          <button
            (click)="isTelefonica.set(true)"
            [class]="
              isTelefonica()
                ? 'flex-1 p-4 rounded-lg border-2 border-blue-600 bg-blue-50'
                : 'flex-1 p-4 rounded-lg border border-slate-300 bg-white hover:border-blue-500'
            "
          >
            <div class="text-center">
              <svg
                class="w-8 h-8 mx-auto mb-2"
                [class.text-blue-600]="isTelefonica()"
                [class.text-slate-600]="!isTelefonica()"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"
                />
              </svg>
              <p
                class="font-semibold"
                [class.text-blue-900]="isTelefonica()"
                [class.text-slate-700]="!isTelefonica()"
              >
                Videoconsulta
              </p>
            </div>
          </button>

          <button
            disabled
            class="flex-1 p-4 rounded-lg border border-slate-200 bg-slate-50 cursor-not-allowed opacity-50"
            title="Las citas presenciales no están disponibles temporalmente"
          >
            <div class="text-center">
              <svg
                class="w-8 h-8 mx-auto mb-2 text-slate-400"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                  clip-rule="evenodd"
                />
              </svg>
              <p class="font-semibold text-slate-500">
                Presencial
                <span class="block text-xs mt-1">(No disponible)</span>
              </p>
            </div>
          </button>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-4">
        <button
          (click)="goToStep(1)"
          class="px-6 py-3 border border-slate-300 rounded-lg text-slate-700 font-semibold hover:bg-slate-50"
        >
          Volver
        </button>
        <button
          (click)="goToStep(3)"
          [disabled]="!canGoToStep3()"
          class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
        >
          Continuar
        </button>
      </div>
    </div>
  }

  <!-- Step 3: Confirmation -->
  @if (currentStep() === 3) {
    <div class="max-w-2xl mx-auto">
      <h2 class="text-2xl font-semibold text-slate-900 mb-6">Confirma tu Cita Médica</h2>

      <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <div class="space-y-4">
          <!-- Doctor -->
          <div>
            <p class="text-sm text-slate-600 mb-1">Médico</p>
            <p class="font-semibold text-slate-900">{{ selectedMedicoName() }}</p>
            <p class="text-sm text-slate-600">{{ selectedMedicoEspecialidad() }}</p>
          </div>

          <!-- Date & Time -->
          <div>
            <p class="text-sm text-slate-600 mb-1">Fecha y Hora</p>
            <p class="font-semibold text-slate-900">{{ selectedDateTimeFormatted() }}</p>
          </div>

          <!-- Modalidad -->
          <div>
            <p class="text-sm text-slate-600 mb-1">Modalidad</p>
            <div class="flex items-center gap-2">
              @if (isTelefonica()) {
                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"
                  />
                </svg>
                <span class="font-semibold text-slate-900">Videoconsulta</span>
              } @else {
                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-semibold text-slate-900">Presencial</span>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-4">
        <button
          (click)="goToStep(2)"
          [disabled]="submitting()"
          class="px-6 py-3 border border-slate-300 rounded-lg text-slate-700 font-semibold hover:bg-slate-50 disabled:opacity-50"
        >
          Volver
        </button>
        <button
          (click)="confirmarCita()"
          [disabled]="submitting()"
          class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          @if (submitting()) {
            <div
              class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"
            ></div>
            <span>Agendando...</span>
          } @else {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
            <span>Agendar Cita</span>
          }
        </button>
      </div>
    </div>
  }
</div>
